<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - College System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .dashboard-content {
            padding: 40px;
        }
        
        .user-info {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            word-break: break-word;
        }
        
        .user-info h3 {
            color: #333;
            margin-bottom: 15px;
        }
        
        .info-item {
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .attendance-section {
            background: #f0f8ff;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .attendance-btn {
            background: linear-gradient(to right, #10b981, #059669);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
        }
        
        .attendance-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .attendance-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        
        .attendance-status {
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            font-weight: 600;
        }
        
        .today-attendance {
            background: #fff7ed;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .monthly-stats {
            background: #f0f9ff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e0f2fe;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #0369a1;
        }
        
        .stat-label {
            font-size: 12px;
            color: #64748b;
            margin-top: 5px;
        }
        
        .actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .action-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border: 2px solid #f0f0f0;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .action-card:hover {
            transform: translateY(-5px);
            border-color: #6a11cb;
        }
        
        .action-icon {
            font-size: 40px;
            margin-bottom: 15px;
        }
        
        .logout-btn {
            background: linear-gradient(to right, #ff416c, #ff4b2b);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .logout-btn:hover {
            opacity: 0.9;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            max-width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
        }
        
        .close {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 24px;
            cursor: pointer;
        }
        
        .attendance-record {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #10b981;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Calendar styles - responsive */
        .calendar-wrapper {
            overflow-x: auto; /* allow horizontal scroll on small screens */
            padding-bottom: 8px;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, minmax(60px, 1fr));
            gap: 5px;
            margin: 15px 0;
            align-items: stretch;
        }
        
        .calendar-day {
            padding: 10px;
            text-align: center;
            border-radius: 5px;
            background: #f8f9fa;
            min-width: 60px;
            word-break: break-word;
            font-size: 14px;
        }
        
        .calendar-day.present {
            background: #d1fae5;
            color: #065f46;
            font-weight: bold;
        }
        
        .calendar-day.absent {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .calendar-day-header {
            font-weight: bold;
            background: #e2e8f0;
            padding: 8px;
        }
        
        .admin-btn {
            background: linear-gradient(to right, #8b5cf6, #7c3aed);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
        }

        /* Admin Panel Styles */
        .admin-student-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #8b5cf6;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .admin-student-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .admin-student-card h4 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .admin-student-card p {
            margin: 5px 0;
            color: #555;
        }
        
        .student-details-modal {
            max-width: 800px;
        }
        
        .student-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .student-detail-card {
            background: #f0f9ff;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .student-attendance-records {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .search-container {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-container input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .search-container:after {
            content: "üîç";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }

        /* Admin Only Dashboard Styles */
        .admin-dashboard {
            display: none;
        }
        
        .admin-dashboard.active {
            display: block;
        }
        
        .admin-welcome {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .admin-welcome h2 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .admin-welcome p {
            color: #666;
            font-size: 16px;
        }

        /* small screen tweaks */
        @media (max-width: 480px) {
            .calendar { grid-auto-rows: 48px; }
            .calendar-day { padding: 6px; font-size: 12px; min-width: 48px; }
            .header h1 { font-size: 22px; }
            .dashboard-content { padding: 20px; }
            .student-details-grid { grid-template-columns: 1fr; }
        }
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <!-- Chart.js for Statistics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Welcome to Dashboard</h1>
            <p>College Attendance System</p>
            <button class="admin-btn" id="adminPanelBtn" style="display: none;" onclick="openAdminPanel()">Admin Panel</button>
        </div>
        
        <!-- Regular User Dashboard -->
        <div class="dashboard-content" id="regularDashboard">
            <!-- User Information -->
            <div class="user-info">
                <h3>User Information</h3>
                <div class="info-item">
                    <strong>Email:</strong> <span id="userEmail">Loading...</span>
                </div>
                <div class="info-item">
                    <strong>Full Name:</strong> <span id="userName">Loading...</span>
                </div>
                <div class="info-item">
                    <strong>Phone:</strong> <span id="userPhone">Loading...</span>
                </div>
                <div class="info-item">
                    <strong>User ID:</strong> <span id="userId">Loading...</span>
                </div>
            </div>
            
            <!-- Attendance Section -->
            <div class="attendance-section">
                <h3>Mark Your Attendance</h3>
                <button class="attendance-btn" id="markAttendanceBtn" onclick="markAttendance()">
                    Mark Today's Attendance
                </button>
                <div id="attendanceStatus" class="attendance-status"></div>
                
                <div id="todayAttendance" class="today-attendance" style="display: none;">
                    <h4>Today's Attendance</h4>
                    <p><strong>Time:</strong> <span id="attendanceTime"></span></p>
                    <p><strong>Date:</strong> <span id="attendanceDate"></span></p>
                    <p><strong>Status:</strong> <span style="color: green;">Present ‚úÖ</span></p>
                </div>

                <!-- Monthly Statistics -->
                <div class="monthly-stats">
                    <h4>üìä This Month's Attendance (Running Month)</h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="monthWorkingDays">0</div>
                            <div class="stat-label">Working Days</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="monthPresent">0</div>
                            <div class="stat-label">Present</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="monthAbsent">0</div>
                            <div class="stat-label">Absent</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="monthPercentage">0%</div>
                            <div class="stat-label">Percentage</div>
                        </div>
                    </div>
                    
                    <!-- Monthly Calendar View -->
                    <div id="monthCalendar" style="margin-top: 20px;" class="calendar-wrapper"></div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="actions">
                <div class="action-card" onclick="viewProfile()">
                    <div class="action-icon">üë§</div>
                    <h3>View Profile</h3>
                    <p>Check your personal information</p>
                </div>
                
                <div class="action-card" onclick="viewAttendanceRecords()">
                    <div class="action-icon">üìä</div>
                    <h3>Attendance Records</h3>
                    <p>View your attendance history</p>
                </div>
                
                <div class="action-card" onclick="viewDetailedStats()">
                    <div class="action-icon">üìà</div>
                    <h3>Detailed Statistics</h3>
                    <p>Charts and detailed analysis</p>
                </div>
            </div>
            
            <center>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </center>
        </div>
        
        <!-- Admin Only Dashboard -->
        <div class="admin-dashboard" id="adminDashboard">
            <div class="admin-welcome">
                <h2>Welcome, Administrator</h2>
                <p>You have access to the full admin panel to manage all student data</p>
            </div>
            
            <div class="user-info">
                <h3>Admin Information</h3>
                <div class="info-item">
                    <strong>Email:</strong> <span id="adminEmail">Loading...</span>
                </div>
                <div class="info-item">
                    <strong>Full Name:</strong> <span id="adminName">Loading...</span>
                </div>
                <div class="info-item">
                    <strong>Phone:</strong> <span id="adminPhone">Loading...</span>
                </div>
                <div class="info-item">
                    <strong>Role:</strong> <span style="color: #8b5cf6; font-weight: bold;">Administrator</span>
                </div>
            </div>
            
            <div class="actions">
                <div class="action-card" onclick="openAdminPanel()">
                    <div class="action-icon">üë•</div>
                    <h3>Manage Students</h3>
                    <p>View and manage all student data</p>
                </div>
                
                <div class="action-card" onclick="exportToCSV()">
                    <div class="action-icon">üì§</div>
                    <h3>Export Data</h3>
                    <p>Export student data to CSV</p>
                </div>
                
                <div class="action-card" onclick="viewAdminProfile()">
                    <div class="action-icon">üë§</div>
                    <h3>Admin Profile</h3>
                    <p>View your admin profile</p>
                </div>
            </div>
            
            <center>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </center>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('profileModal')">&times;</span>
            <h2>Your Profile</h2>
            <div id="profileInfo"></div>
        </div>
    </div>

    <!-- Attendance Records Modal -->
    <div id="recordsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('recordsModal')">&times;</span>
            <h2>Attendance Records</h2>
            <div id="attendanceRecords"></div>
        </div>
    </div>

    <!-- Statistics Modal -->
    <div id="statsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('statsModal')">&times;</span>
            <h2>Detailed Attendance Statistics</h2>
            <div id="attendanceStats">
                <canvas id="attendanceChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div id="adminModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('adminModal')">&times;</span>
            <h2>üìä Admin Panel - All Students Report</h2>
            <div id="adminContent">
                <div style="margin-bottom: 20px;">
                    <div class="search-container">
                        <input type="text" id="searchStudent" placeholder="Search students by name, email, or phone..." onkeyup="filterStudents()">
                    </div>
                    <button onclick="loadAllStudents()" class="admin-btn">Refresh Data</button>
                    <button onclick="exportToCSV()" class="admin-btn">Export to CSV</button>
                </div>
                <div id="allStudentsData" style="max-height: 500px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <!-- Student Details Modal -->
    <div id="studentDetailsModal" class="modal">
        <div class="modal-content student-details-modal">
            <span class="close" onclick="closeModal('studentDetailsModal')">&times;</span>
            <h2>Student Details</h2>
            <div id="studentDetailsContent"></div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAn2MiKH9C3CXd_UBFvgy_8rxiENBsiJpc",
            authDomain: "rainweblogin-pagedatabase.firebaseapp.com",
            projectId: "rainweblogin-pagedatabase",
            storageBucket: "rainweblogin-pagedatabase.firebasestorage.app",
            messagingSenderId: "205913357514",
            appId: "1:205913357514:web:d83813940596f85e3c4833",
            measurementId: "G-1LZD8HGKDP"
        };

        // Initialize Firebase
        let auth, db;
        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
        } catch (error) {
            console.error('Firebase initialization error:', error);
        }

        // Global variables
        let currentUser = null;
        let userData = null;
        let allAttendanceRecords = [];
        let attendanceChart = null;
        let allStudentsData = []; // Store all students data for search
        let isAdminUser = false;

        // Check if user is logged in and load data
        window.addEventListener('load', async function() {
            try {
                currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            } catch (err) {
                currentUser = null;
            }
            
            if (!currentUser || !currentUser.email || !currentUser.uid) {
                window.location.href = 'index.html';
                return;
            }

            // Display basic user info
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('userId').textContent = currentUser.uid || 'N/A';
            document.getElementById('adminEmail').textContent = currentUser.email;

            // Load user data from Firestore
            await loadUserData();
            
            // Check if user is admin and show appropriate dashboard
            await checkAdminStatus();
            
            if (isAdminUser) {
                // Show admin dashboard and hide regular dashboard
                document.getElementById('regularDashboard').style.display = 'none';
                document.getElementById('adminDashboard').classList.add('active');
                document.getElementById('adminPanelBtn').style.display = 'inline-block';
                
                // Load admin data
                await loadAllStudents();
            } else {
                // Show regular dashboard
                document.getElementById('regularDashboard').style.display = 'block';
                document.getElementById('adminDashboard').classList.remove('active');
                
                // Load all attendance records for regular users
                await loadAllAttendanceRecords();
                
                // Check today's attendance
                await checkTodaysAttendance();

                // Calculate and display monthly statistics
                await calculateMonthlyStats();
            }
        });

        // Load user data from Firestore
        async function loadUserData() {
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    userData = userDoc.data();
                    // Display user information on dashboard
                    document.getElementById('userName').textContent = userData.fullName || 'Not set';
                    document.getElementById('userPhone').textContent = userData.phone || 'Not set';
                    document.getElementById('adminName').textContent = userData.fullName || 'Not set';
                    document.getElementById('adminPhone').textContent = userData.phone || 'Not set';
                } else {
                    // If user doc doesn't exist, create one with minimal info
                    await db.collection('users').doc(currentUser.uid).set({
                        email: currentUser.email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        status: 'active'
                    }, { merge: true });
                    
                    // Set default values for display
                    document.getElementById('userName').textContent = 'Not set';
                    document.getElementById('userPhone').textContent = 'Not set';
                    document.getElementById('adminName').textContent = 'Not set';
                    document.getElementById('adminPhone').textContent = 'Not set';
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                // Set default values in case of error
                document.getElementById('userName').textContent = 'Error loading';
                document.getElementById('userPhone').textContent = 'Error loading';
                document.getElementById('adminName').textContent = 'Error loading';
                document.getElementById('adminPhone').textContent = 'Error loading';
            }
        }

        // Check if user is admin
        async function checkAdminStatus() {
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    isAdminUser = userData.role === 'admin';
                }
            } catch (error) {
                console.error('Error checking admin status:', error);
            }
        }

        // Load all attendance records (for regular users)
        async function loadAllAttendanceRecords() {
            try {
                const attendanceQuery = await db.collection('attendance')
                    .where('userId', '==', currentUser.uid)
                    .get();
                
                allAttendanceRecords = [];
                attendanceQuery.forEach(doc => {
                    allAttendanceRecords.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // Sort by date descending
                allAttendanceRecords.sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    return dateB - dateA;
                });

                console.log('Loaded records:', allAttendanceRecords.length);
                
            } catch (error) {
                console.error('Error loading attendance records:', error);
            }
        }

        // Mark Attendance Function (for regular users)
        async function markAttendance() {
            const btn = document.getElementById('markAttendanceBtn');
            const statusDiv = document.getElementById('attendanceStatus');
            
            btn.innerHTML = '<span class="loading"></span> Marking Attendance...';
            btn.disabled = true;
            statusDiv.textContent = 'Recording your attendance...';
            
            try {
                const now = new Date();
                const attendanceData = {
                    userId: currentUser.uid,
                    email: currentUser.email,
                    fullName: userData?.fullName || 'Unknown',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    date: now.toISOString().split('T')[0],
                    time: now.toLocaleTimeString('en-IN', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: true 
                    }),
                    day: now.toLocaleDateString('en-IN', { weekday: 'long' }),
                    month: now.toLocaleDateString('en-IN', { month: 'long' }),
                    year: now.getFullYear(),
                    status: 'present'
                };

                await db.collection('attendance').add(attendanceData);
                await loadAllAttendanceRecords();
                
                statusDiv.innerHTML = '<span style="color: green;">‚úÖ Attendance marked successfully!</span>';
                btn.style.display = 'none';
                
                document.getElementById('attendanceTime').textContent = attendanceData.time;
                document.getElementById('attendanceDate').textContent = 
                    `${attendanceData.day}, ${attendanceData.date}`;
                document.getElementById('todayAttendance').style.display = 'block';
                
                await calculateMonthlyStats();
                
            } catch (error) {
                console.error('Error marking attendance:', error);
                statusDiv.innerHTML = '<span style="color: red;">‚ùå Error marking attendance. Please try again.</span>';
                btn.innerHTML = 'Mark Today\'s Attendance';
                btn.disabled = false;
            }
        }

        // Check if attendance already marked today (for regular users)
        async function checkTodaysAttendance() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const todayRecord = allAttendanceRecords.find(record => record.date === today);
                
                if (todayRecord) {
                    document.getElementById('markAttendanceBtn').style.display = 'none';
                    document.getElementById('attendanceTime').textContent = todayRecord.time;
                    document.getElementById('attendanceDate').textContent = 
                        `${todayRecord.day}, ${todayRecord.date}`;
                    document.getElementById('todayAttendance').style.display = 'block';
                    document.getElementById('attendanceStatus').innerHTML = 
                        '<span style="color: green;">‚úÖ Attendance already marked for today</span>';
                }
            } catch (error) {
                console.error('Error checking attendance:', error);
            }
        }

        // Calculate Monthly Statistics (FIXED - Running Month) (for regular users)
        async function calculateMonthlyStats() {
            try {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                
                // Get current month's records
                const monthRecords = allAttendanceRecords.filter(record => {
                    const recordDate = new Date(record.date);
                    return recordDate.getMonth() === currentMonth && 
                           recordDate.getFullYear() === currentYear;
                });
                
                // Calculate working days in current month (excluding weekends)
                const firstDay = new Date(currentYear, currentMonth, 1);
                const lastDay = new Date(currentYear, currentMonth + 1, 0);
                let workingDays = 0;
                
                for (let day = new Date(firstDay); day <= lastDay; day.setDate(day.getDate() + 1)) {
                    if (day.getDay() !== 0 && day.getDay() !== 6) { // Exclude Sunday (0) and Saturday (6)
                        workingDays++;
                    }
                }
                
                const presentDays = monthRecords.length;
                const absentDays = Math.max(0, workingDays - presentDays);
                const percentage = workingDays > 0 ? ((presentDays / workingDays) * 100).toFixed(1) : 0;
                
                // Update display
                document.getElementById('monthWorkingDays').textContent = workingDays;
                document.getElementById('monthPresent').textContent = presentDays;
                document.getElementById('monthAbsent').textContent = absentDays;
                document.getElementById('monthPercentage').textContent = percentage + '%';
                
                // Generate calendar view
                generateCalendarView(currentMonth, currentYear, monthRecords);
                
            } catch (error) {
                console.error('Error calculating monthly stats:', error);
            }
        }

        // Generate Calendar View (for regular users)
        function generateCalendarView(month, year, records) {
            const calendarDiv = document.getElementById('monthCalendar');
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            
            let calendarHTML = '<div class="calendar">';
            
            // Add day headers
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            days.forEach(day => {
                calendarHTML += `<div class="calendar-day calendar-day-header">${day}</div>`;
            });
            
            // Add empty cells for days before the first day of month
            for (let i = 0; i < firstDay.getDay(); i++) {
                calendarHTML += '<div class="calendar-day"></div>';
            }
            
            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isPresent = records.some(record => record.date === dateStr);
                const isToday = dateStr === new Date().toISOString().split('T')[0];
                const isWeekend = new Date(year, month, day).getDay() === 0 || 
                                 new Date(year, month, day).getDay() === 6;
                
                let dayClass = 'calendar-day';
                if (isPresent) dayClass += ' present';
                else if (!isWeekend && day <= new Date().getDate()) dayClass += ' absent';
                
                calendarHTML += `<div class="${dayClass}">${day}${isToday ? ' üìç' : ''}</div>`;
            }
            
            calendarHTML += '</div>';
            calendarDiv.innerHTML = calendarHTML;
        }

        // View Profile Function (for regular users)
        async function viewProfile() {
            const modal = document.getElementById('profileModal');
            const profileInfo = document.getElementById('profileInfo');
            
            profileInfo.innerHTML = `
                <div style="line-height: 2;">
                    <p><strong>Email:</strong> ${currentUser.email}</p>
                    <p><strong>Full Name:</strong> ${userData?.fullName || 'Not set'}</p>
                    <p><strong>Phone:</strong> ${userData?.phone || 'Not set'}</p>
                    <p><strong>User ID:</strong> ${currentUser.uid}</p>
                    <p><strong>Total Attendance Records:</strong> ${allAttendanceRecords.length}</p>
                    <p><strong>Member Since:</strong> ${userData?.createdAt ? 
                        new Date(userData.createdAt.seconds * 1000).toLocaleDateString() : 'Unknown'}</p>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        // View Admin Profile Function
        async function viewAdminProfile() {
            const modal = document.getElementById('profileModal');
            const profileInfo = document.getElementById('profileInfo');
            
            profileInfo.innerHTML = `
                <div style="line-height: 2;">
                    <p><strong>Email:</strong> ${currentUser.email}</p>
                    <p><strong>Full Name:</strong> ${userData?.fullName || 'Not set'}</p>
                    <p><strong>Phone:</strong> ${userData?.phone || 'Not set'}</p>
                    <p><strong>User ID:</strong> ${currentUser.uid}</p>
                    <p><strong>Role:</strong> <span style="color: #8b5cf6; font-weight: bold;">Administrator</span></p>
                    <p><strong>Member Since:</strong> ${userData?.createdAt ? 
                        new Date(userData.createdAt.seconds * 1000).toLocaleDateString() : 'Unknown'}</p>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        // View Attendance Records (for regular users)
        async function viewAttendanceRecords() {
            const modal = document.getElementById('recordsModal');
            const recordsDiv = document.getElementById('attendanceRecords');
            
            recordsDiv.innerHTML = '<p>Loading attendance records...</p>';
            modal.style.display = 'block';
            
            try {
                if (allAttendanceRecords.length === 0) {
                    recordsDiv.innerHTML = '<p>No attendance records found.</p>';
                    return;
                }
                
                let recordsHTML = '<div style="max-height: 400px; overflow-y: auto;">';
                
                allAttendanceRecords.forEach(record => {
                    recordsHTML += `
                        <div class="attendance-record">
                            <p><strong>Date:</strong> ${record.day}, ${record.date}</p>
                            <p><strong>Time:</strong> ${record.time}</p>
                            <p><strong>Status:</strong> <span style="color: green;">PRESENT</span></p>
                        </div>
                    `;
                });
                
                recordsHTML += '</div>';
                recordsDiv.innerHTML = recordsHTML;
                
            } catch (error) {
                console.error('Error loading attendance records:', error);
                recordsDiv.innerHTML = '<p style="color: red;">Error loading records.</p>';
            }
        }

        // View Detailed Statistics with Charts (for regular users)
        async function viewDetailedStats() {
            const modal = document.getElementById('statsModal');
            const statsDiv = document.getElementById('attendanceStats');
            
            statsDiv.innerHTML = '<p>Loading statistics...</p>';
            modal.style.display = 'block';
            
            try {
                // Monthly data for chart
                const monthlyData = {};
                allAttendanceRecords.forEach(record => {
                    const date = new Date(record.date);
                    const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    
                    if (!monthlyData[monthYear]) {
                        monthlyData[monthYear] = 0;
                    }
                    monthlyData[monthYear]++;
                });
                
                // Prepare chart data
                const labels = Object.keys(monthlyData).sort();
                const data = labels.map(label => monthlyData[label]);
                
                statsDiv.innerHTML = `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <h3>Monthly Attendance Overview</h3>
                    </div>
                    <canvas id="attendanceChart" width="400" height="200"></canvas>
                    <div style="margin-top: 20px;">
                        <p><strong>Total Records:</strong> ${allAttendanceRecords.length}</p>
                        <p><strong>First Record:</strong> ${allAttendanceRecords.length > 0 ? 
                            `${allAttendanceRecords[allAttendanceRecords.length-1].date}` : 'N/A'}</p>
                        <p><strong>Latest Record:</strong> ${allAttendanceRecords.length > 0 ? 
                            `${allAttendanceRecords[0].date}` : 'N/A'}</p>
                    </div>
                `;
                
                // Render chart
                const ctx = document.getElementById('attendanceChart').getContext('2d');
                if (attendanceChart) {
                    attendanceChart.destroy();
                }
                
                attendanceChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Attendance Days',
                            data: data,
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Days Present'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Month-Year'
                                }
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('Error loading statistics:', error);
                statsDiv.innerHTML = '<p style="color: red;">Error loading statistics.</p>';
            }
        }

        // Load All Students Data (Admin Function)
        async function loadAllStudents() {
            const studentsDiv = document.getElementById('allStudentsData');
            studentsDiv.innerHTML = '<p>Loading student data...</p>';
            
            try {
                // Get all users
                const usersQuery = await db.collection('users').get();
                allStudentsData = [];
                
                for (const userDoc of usersQuery.docs) {
                    const userData = userDoc.data();
                    
                    // Get attendance records for this user
                    const attendanceQuery = await db.collection('attendance')
                        .where('userId', '==', userDoc.id)
                        .get();
                    
                    const attendanceRecords = [];
                    attendanceQuery.forEach(doc => {
                        attendanceRecords.push(doc.data());
                    });
                    
                    // Calculate stats
                    const totalAttendance = attendanceRecords.length;
                    const lastAttendance = attendanceRecords.length > 0 ? 
                        attendanceRecords[0].date : 'No records';
                    
                    allStudentsData.push({
                        id: userDoc.id,
                        ...userData,
                        totalAttendance,
                        lastAttendance,
                        attendanceRecords
                    });
                }
                
                // Sort by name
                allStudentsData.sort((a, b) => (a.fullName || '').localeCompare(b.fullName || ''));
                
                // Display students
                displayStudents(allStudentsData);
                
            } catch (error) {
                console.error('Error loading students:', error);
                studentsDiv.innerHTML = '<p style="color: red;">Error loading student data.</p>';
            }
        }

        // Display Students in Admin Panel
        function displayStudents(students) {
            const studentsDiv = document.getElementById('allStudentsData');
            
            if (students.length === 0) {
                studentsDiv.innerHTML = '<p>No students found.</p>';
                return;
            }
            
            let studentsHTML = '';
            
            students.forEach(student => {
                studentsHTML += `
                    <div class="admin-student-card" onclick="viewStudentDetails('${student.id}')">
                        <h4>${student.fullName || 'Unknown'}</h4>
                        <p><strong>Email:</strong> ${student.email}</p>
                        <p><strong>Phone:</strong> ${student.phone || 'Not set'}</p>
                        <p><strong>Total Attendance:</strong> ${student.totalAttendance} days</p>
                        <p><strong>Last Attendance:</strong> ${student.lastAttendance}</p>
                        <p><strong>Role:</strong> ${student.role || 'student'}</p>
                    </div>
                `;
            });
            
            studentsDiv.innerHTML = studentsHTML;
        }

        // Filter Students in Admin Panel
        function filterStudents() {
            const searchTerm = document.getElementById('searchStudent').value.toLowerCase();
            
            const filteredStudents = allStudentsData.filter(student => {
                return (
                    (student.fullName && student.fullName.toLowerCase().includes(searchTerm)) ||
                    (student.email && student.email.toLowerCase().includes(searchTerm)) ||
                    (student.phone && student.phone.toLowerCase().includes(searchTerm))
                );
            });
            
            displayStudents(filteredStudents);
        }

        // View Student Details (Admin Function)
        function viewStudentDetails(studentId) {
            const student = allStudentsData.find(s => s.id === studentId);
            if (!student) return;
            
            const modal = document.getElementById('studentDetailsModal');
            const contentDiv = document.getElementById('studentDetailsContent');
            
            contentDiv.innerHTML = `
                <div class="student-details-grid">
                    <div class="student-detail-card">
                        <h4>Full Name</h4>
                        <p>${student.fullName || 'Unknown'}</p>
                    </div>
                    <div class="student-detail-card">
                        <h4>Email</h4>
                        <p>${student.email}</p>
                    </div>
                    <div class="student-detail-card">
                        <h4>Phone</h4>
                        <p>${student.phone || 'Not set'}</p>
                    </div>
                    <div class="student-detail-card">
                        <h4>Total Attendance</h4>
                        <p>${student.totalAttendance} days</p>
                    </div>
                    <div class="student-detail-card">
                        <h4>Last Attendance</h4>
                        <p>${student.lastAttendance}</p>
                    </div>
                    <div class="student-detail-card">
                        <h4>Role</h4>
                        <p>${student.role || 'student'}</p>
                    </div>
                </div>
                
                <h3 style="margin-top: 20px;">Attendance Records</h3>
                <div class="student-attendance-records">
                    ${student.attendanceRecords.length > 0 ? 
                        student.attendanceRecords.map(record => `
                            <div class="attendance-record">
                                <p><strong>Date:</strong> ${record.day}, ${record.date}</p>
                                <p><strong>Time:</strong> ${record.time}</p>
                            </div>
                        `).join('') : 
                        '<p>No attendance records found.</p>'
                    }
                </div>
            `;
            
            modal.style.display = 'block';
        }

        // Export to CSV (Admin Function)
        function exportToCSV() {
            if (allStudentsData.length === 0) {
                alert('No data to export.');
                return;
            }
            
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Add header
            csvContent += "Name,Email,Phone,Total Attendance,Last Attendance,Role\n";
            
            // Add data
            allStudentsData.forEach(student => {
                const row = [
                    student.fullName || 'Unknown',
                    student.email,
                    student.phone || '',
                    student.totalAttendance,
                    student.lastAttendance,
                    student.role || 'student'
                ].map(field => `"${field}"`).join(',');
                
                csvContent += row + "\n";
            });
            
            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "students_data.csv");
            document.body.appendChild(link);
            
            // Trigger download
            link.click();
            document.body.removeChild(link);
        }

        // Open Admin Panel
        function openAdminPanel() {
            document.getElementById('adminModal').style.display = 'block';
        }

        // Close Modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Logout Function
        function logout() {
            if (auth) {
                auth.signOut().then(() => {
                    localStorage.removeItem('currentUser');
                    window.location.href = 'index.html';
                }).catch(error => {
                    console.error('Logout error:', error);
                    // Fallback: clear localStorage and redirect
                    localStorage.removeItem('currentUser');
                    window.location.href = 'index.html';
                });
            } else {
                // Fallback: clear localStorage and redirect
                localStorage.removeItem('currentUser');
                window.location.href = 'index.html';
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modals = document.getElementsByClassName('modal');
            for (let modal of modals) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            }
        }
    </script>
</body>
</html>
